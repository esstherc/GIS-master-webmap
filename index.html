<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive GIS Master's Programs Map</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="style/main.css" />
</head>

<body>
    <div class="header">
        <h1>GIS Master's Programs in the US</h1>
        <h2>Explore 172 GIS master's programs across 140 institutions in the U.S.</h2>
        <p class="author-info">Yanbing Chen, 2025</p>
    </div>

    <div class="container">
        <div class="sidebar">
            <div class="stats-legend-container">
                <div class="stats" id="stats">
                    <h4><i class="fas fa-chart-bar"></i> Statistics</h4>
                    <div class="stat-item">
                        <span>Total Institutions:</span>
                        <span id="total-institutions">-</span>
                    </div>
                    <div class="stat-item">
                        <span>Total Programs:</span>
                        <span id="total-programs">-</span>
                    </div>
                    <div class="stat-item">
                        <span><strong># of Matching Institutions:</strong></span>
                        <span id="visible-count">-</span>
                    </div>
                </div>

                <div class="legend">
                    <h4><i class="fas fa-info-circle"></i> Program Types</h4>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #599af4;"></div>
                        <span>Professional</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #fb9090;"></div>
                        <span>Research</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #92df92;"></div>
                        <span>Mixed</span>
                    </div>
                </div>
            </div>

            <div class="filter-section">
                <h3><i class="fas fa-filter"></i> Filters</h3>
                
                <div class="filters-grid">
                    <div class="filter-group">
                        <label for="state-filter">State:</label>
                        <select id="state-filter">
                            <option value="">All States</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label for="type-filter">Program Type:</label>
                        <select id="type-filter">
                            <option value="">All Types</option>
                        </select>
                    </div>
                </div>

                <div class="filters-grid">
                    <div class="filter-group">
                        <label for="location-filter">Format:</label>
                        <select id="location-filter">
                            <option value="">All Formats</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label for="search-filter">Search:</label>
                        <input type="text" id="search-filter" placeholder="Type to search...">
                    </div>
                </div>

                <div class="button-row">
                    <button class="btn btn-primary" onclick="applyFilters()">
                        <i class="fas fa-search"></i> Apply Filters
                    </button>
                    
                    <button class="btn btn-secondary" onclick="clearFilters()">
                        <i class="fas fa-times"></i> Clear All
                    </button>
                </div>
            </div>

            <div class="export-section">
                <button class="export-btn" onclick="exportToCSV()">
                    <i class="fas fa-download"></i> Download Saved Programs
                </button>
            </div>
        </div>

        <div class="map-container">
            <div id="map"></div>
        </div>
    </div>

    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- PapaParse for CSV reading -->
    <script src="https://unpkg.com/papaparse@5.3.0/papaparse.min.js"></script>

    <script>
        // Global variables
        let map;
        let markers = [];
        let allData = [];
        let institutionData = new Map();

        // Color scheme for program types
        const colorMap = {
            'professional': '#599af4',
            'research': '#fb9090',
            'mixed': '#92df92',
            'default': '#ffaa00'
        };

        // Initialize map
        function initMap() {
            map = L.map('map', {
                minZoom: 4
            }).setView([39.8283, -98.5795], 5);
            
            // Add Stadia Stamen Toner Lite basemap
            L.tileLayer('https://tiles.stadiamaps.com/tiles/stamen_toner_lite/{z}/{x}/{y}{r}.{ext}?api_key=a83e3eb2-e11a-4f18-8f4c-430515354603', {
                minZoom: 4,
                maxZoom: 20,
                attribution: '&copy; <a href="https://www.stadiamaps.com/" target="_blank">Stadia Maps</a> &copy; <a href="https://www.stamen.com/" target="_blank">Stamen Design</a> &copy; <a href="https://openmaptiles.org/" target="_blank">OpenMapTiles</a> &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                ext: 'png'
            }).addTo(map);
        }

        // Load and process data
        async function loadData() {
            try {
                console.log('Starting to load data...');
                
                // Load program data
                console.log('Loading program data...');
                const programResponse = await fetch('data/all_msgis_institutions.csv');
                
                if (!programResponse.ok) {
                    throw new Error(`Failed to load program data: ${programResponse.status} ${programResponse.statusText}`);
                }
                
                const programText = await programResponse.text();
                console.log('Program data loaded, parsing...');
                const programData = Papa.parse(programText, { header: true }).data;
                console.log('Program data parsed:', programData.length, 'records');

                // Load coordinates data 
                console.log('Loading coordinates data...');
                const coordResponse = await fetch('data/universities_coordinates_all.csv');
                
                if (!coordResponse.ok) {
                    throw new Error(`Failed to load coordinates data: ${coordResponse.status} ${coordResponse.statusText}`);
                }
                
                const coordText = await coordResponse.text();
                console.log('Coordinates data loaded, parsing...');
                const coordData = Papa.parse(coordText, { header: true }).data;
                console.log('Coordinates data parsed:', coordData.length, 'records');

                // Merge data
                console.log('Merging data...');
                allData = mergeData(programData, coordData);
                console.log('Data merged:', allData.length, 'records');
                
                processData();
                createMarkers();
                populateFilters();
                updateStats();
                updateAllNoteDisplays();

                console.log('Data loading completed successfully');

            } catch (error) {
                console.error('Error loading data:', error);
                alert(`Error loading data: ${error.message}\n\nPlease make sure:\n1. You are running this from a web server (not file://)\n2. The CSV files exist in the data/ directory\n3. The server allows CORS requests`);
            }
        }

        // Merge program and coordinate data
        function mergeData(programData, coordData) {
            const coordMap = new Map();
            coordData.forEach(coord => {
                if (coord.Latitude && coord.Longitude) {
                    coordMap.set(coord.University, {
                        lat: parseFloat(coord.Latitude),
                        lng: parseFloat(coord.Longitude),
                        state: coord.State,
                        city: coord.City,
                        address: coord.Address
                    });
                }
            });

            return programData.filter(program => {
                const coords = coordMap.get(program.Institution);
                if (coords) {
                    program.latitude = coords.lat;
                    program.longitude = coords.lng;
                    program.state = coords.state;
                    program.city = coords.city;
                    program.address = coords.address;
                    return true;
                }
                return false;
            });
        }

        // Process data to group by institution
        function processData() {
            institutionData.clear();

            allData.forEach(program => {
                const key = program.Institution;
                if (!institutionData.has(key)) {
                    institutionData.set(key, {
                        institution: program.Institution,
                        latitude: program.latitude,
                        longitude: program.longitude,
                        state: program.state,
                        city: program.city,
                        address: program.address,
                        programs: []
                    });
                }

                institutionData.get(key).programs.push({
                    name: program.Program,
                    link: program.link,
                    type: program['program type'],
                    graduation: program['graduation requirement'],
                    duration: program.duration,
                    location: program.location,
                    institutionType: program['institution type']
                });
            });
        }

        // Create markers on map
        function createMarkers() {
            // Clear existing markers
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];

            // Ê†πÊçÆÂ±èÂπïÂ§ßÂ∞èÂíåÁº©ÊîæÁ∫ßÂà´Âä®ÊÄÅË∞ÉÊï¥Ê†áËÆ∞Â§ßÂ∞è
            const isMobile = window.innerWidth <= 768;
            const isSmallMobile = window.innerWidth <= 480;
            const currentZoom = map.getZoom();
            
            // Âü∫Á°ÄÂ§ßÂ∞è
            let baseSize, borderWidth, shadowSize;
            if (isSmallMobile) {
                baseSize = 8;
                borderWidth = 1;
                shadowSize = '0 1px 2px rgba(0,0,0,0.3)';
            } else if (isMobile) {
                baseSize = 10;
                borderWidth = 1;
                shadowSize = '0 1px 3px rgba(0,0,0,0.3)';
            } else {
                baseSize = 12;
                borderWidth = 2;
                shadowSize = '0 2px 5px rgba(0,0,0,0.3)';
            }
            
            // Ê†πÊçÆÁº©ÊîæÁ∫ßÂà´Ë∞ÉÊï¥Â§ßÂ∞è
            let markerSize;
            if (currentZoom < 5) {
                markerSize = baseSize * 1.1; // ÊúÄÂ∞èÁº©ÊîæÊó∂ÂæàÂ∞è
            } else if (currentZoom == 5) {
                markerSize = baseSize * 1.5; // Â∞èÁº©ÊîæÊó∂ËæÉÂ∞è
            } else if (currentZoom <= 6) {
                markerSize = baseSize * 1.7; // Â∞èÁº©ÊîæÊó∂ËæÉÂ∞è
            } else if (currentZoom <= 7) {
                markerSize = baseSize *2; // ‰∏≠Á≠âÁº©ÊîæÊó∂Ê≠£Â∏∏Â§ßÂ∞è
            } else if (currentZoom <= 10) {
                markerSize = baseSize * 2; // Â§ßÁº©ÊîæÊó∂ËæÉÂ§ß
            } else {
                markerSize = baseSize * 3; // ÊúÄÂ§ßÁº©ÊîæÊó∂ÊúÄÂ§ß
            }

            institutionData.forEach((data, institution) => {
                // Determine primary program type for marker color
                const programTypes = data.programs.map(p => p.type).filter(t => t);
                const typeCounts = {};
                programTypes.forEach(type => {
                    typeCounts[type] = (typeCounts[type] || 0) + 1;
                });

                const primaryType = Object.keys(typeCounts).length > 0 
                    ? Object.keys(typeCounts).reduce((a, b) => typeCounts[a] > typeCounts[b] ? a : b)
                    : 'default';

                // Create custom icon with responsive size
                const iconColor = colorMap[primaryType] || colorMap.default;
                const customIcon = L.divIcon({
                    className: 'custom-marker',
                    html: `<div style="background-color: ${iconColor}; width: ${markerSize}px; height: ${markerSize}px; border-radius: 50%; border: ${borderWidth}px solid white; box-shadow: ${shadowSize};"></div>`,
                    iconSize: [markerSize, markerSize],
                    iconAnchor: [markerSize/2, markerSize/2]
                });

                // Create popup content
                const popupContent = createPopupContent(data);

                // Create marker
                const marker = L.marker([data.latitude, data.longitude], { icon: customIcon })
                    .bindTooltip(data.institution, {
                        permanent: false,
                        direction: 'top',
                        offset: [0, -10],
                        className: 'custom-tooltip'
                    })
                    .bindPopup(popupContent, { maxWidth: 450 })
                    .addTo(map);

                // Store additional data with marker
                marker.institutionData = data;
                markers.push(marker);
            });
        }

        // Create popup content
        function createPopupContent(data) {
            let content = `
                <div class="popup-content">
                    <div class="popup-header">${data.institution}</div>
                    <p><strong>State:</strong> ${data.state || 'N/A'}</p>
                    <p><strong>City:</strong> ${data.city || 'N/A'}</p>
                    <p><strong>Total Programs:</strong> ${data.programs.length}</p>
                    <hr style="margin: 10px 0;">
            `;

            data.programs.forEach((program, index) => {
                const link = program.link && program.link !== 'N/A' ? program.link : '#';
                const typeColor = colorMap[program.type] || colorMap.default;
                const programId = `${data.institution}_${index}`;
                
                content += `
                    <div class="program-item" style="border-left-color: ${typeColor};">
                        <div class="program-title">
                            <a href="${link}" target="_blank">${program.name || 'N/A'}</a>
                        </div>
                        <div class="program-details">
                            <span><strong>Type:</strong> ${program.type || 'N/A'}</span>
                            <span><strong>Format:</strong> ${program.location || 'N/A'}</span>
                            <br>
                            <span><strong>Duration:</strong> ${program.duration || 'N/A'}</span>
                            <span><strong>Graduation:</strong> ${program.graduation || 'N/A'}</span>
                        </div>
                        <div class="user-notes" data-program-id="${programId}">
                            <div class="note-buttons">
                                <button class="note-btn wishlist-btn" onclick="addToWishlist('${programId}')">
                                    <span class="wishlist-icon">‚≠ê</span> Add to Wishlist
                                </button>
                                <button class="note-btn note-btn" onclick="addNote('${programId}')">
                                    <span class="note-icon">üìù</span> Add Note
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });

            content += '</div>';
            return content;
        }

        // Simple CSV export functionality
        let savedPrograms = JSON.parse(localStorage.getItem('savedPrograms') || '[]');

        function addToWishlist(programId) {
            // Find the program data
            const programData = findProgramById(programId);
            if (programData) {
                // Check if already exists
                const exists = savedPrograms.find(p => p.programId === programId);
                if (!exists) {
                    savedPrograms.push({
                        ...programData,
                        programId: programId,
                        type: 'Wishlist',
                        note: '',
                        dateAdded: new Date().toISOString()
                    });
                    localStorage.setItem('savedPrograms', JSON.stringify(savedPrograms));
                    alert('Added to wishlist!');
                } else {
                    alert('Already in wishlist!');
                }
            }
        }

        function addNote(programId) {
            const note = prompt('Enter your note:');
            if (note && note.trim()) {
                // Find the program data
                const programData = findProgramById(programId);
                if (programData) {
                    // Check if already exists
                    const exists = savedPrograms.find(p => p.programId === programId);
                    if (exists) {
                        // Update existing note
                        exists.note = note.trim();
                        exists.type = exists.type + ' + Note';
                    } else {
                        // Add new entry
                        savedPrograms.push({
                            ...programData,
                            programId: programId,
                            type: 'Note',
                            note: note.trim(),
                            dateAdded: new Date().toISOString()
                        });
                    }
                    localStorage.setItem('savedPrograms', JSON.stringify(savedPrograms));
                    alert('Note added!');
                }
            }
        }

        function findProgramById(programId) {
            // Parse programId to find the program
            const parts = programId.split('_');
            const institution = parts[0];
            const programIndex = parseInt(parts[1]);
            
            // Find in allData
            let currentIndex = 0;
            for (let i = 0; i < allData.length; i++) {
                if (allData[i].Institution === institution) {
                    if (currentIndex === programIndex) {
                        return allData[i];
                    }
                    currentIndex++;
                }
            }
            return null;
        }

        function exportToCSV() {
            if (savedPrograms.length === 0) {
                alert('No saved programs found! Please add some programs to wishlist or add notes first.');
                return;
            }

            try {
                // Prepare CSV data
                const csvData = savedPrograms.map(program => ({
                    'Institution': program.Institution || 'N/A',
                    'Program': program.Program || 'N/A',
                    'State': program.state || 'N/A',
                    'City': program.city || 'N/A',
                    'Program Type': program['program type'] || 'N/A',
                    'Format': program.location || 'N/A',
                    'Duration': program.duration || 'N/A',
                    'Graduation Requirement': program['graduation requirement'] || 'N/A',
                    'Link': program.link || 'N/A',
                    'Saved Type': program.type || 'N/A',
                    'Note': program.note || 'N/A',
                    'Date Added': program.dateAdded || 'N/A'
                }));

                // Convert to CSV
                const csvContent = convertToCSV(csvData);
                downloadCSV(csvContent, 'saved_programs.csv');
                
                alert(`Exported ${savedPrograms.length} programs to CSV!`);

            } catch (error) {
                console.error('Export failed:', error);
                alert('Export failed: ' + error.message);
            }
        }

        function convertToCSV(data) {
            const headers = Object.keys(data[0]);
            const csvRows = [];
            
            // Add header row
            csvRows.push(headers.join(','));
            
            // Add data rows
            data.forEach(row => {
                const values = headers.map(header => {
                    const value = row[header] || '';
                    return `"${value.toString().replace(/"/g, '""')}"`;
                });
                csvRows.push(values.join(','));
            });
            
            return csvRows.join('\n');
        }

        function downloadCSV(csvContent, filename) {
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // Missing functions for statistics and filters
        function processData() {
            institutionData.clear();

            allData.forEach(program => {
                const key = program.Institution;
                if (!institutionData.has(key)) {
                    institutionData.set(key, {
                        institution: program.Institution,
                        latitude: program.latitude,
                        longitude: program.longitude,
                        state: program.state,
                        city: program.city,
                        address: program.address,
                        programs: []
                    });
                }

                institutionData.get(key).programs.push({
                    name: program.Program,
                    link: program.link,
                    type: program['program type'],
                    graduation: program['graduation requirement'],
                    duration: program.duration,
                    location: program.location,
                    institutionType: program['institution type']
                });
            });
        }

        function populateFilters() {
            const states = new Set();
            const types = new Set();
            const locations = new Set();

            allData.forEach(program => {
                if (program.state) states.add(program.state);
                if (program['program type']) types.add(program['program type']);
                if (program.location) locations.add(program.location);
            });

            populateSelect('state-filter', Array.from(states).sort());
            populateSelect('type-filter', Array.from(types).sort());
            populateSelect('location-filter', Array.from(locations).sort());
        }

        function populateSelect(selectId, options) {
            const select = document.getElementById(selectId);
            // Clear existing options except the first one
            while (select.children.length > 1) {
                select.removeChild(select.lastChild);
            }
            
            options.forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option;
                optionElement.textContent = option;
                select.appendChild(optionElement);
            });
        }

        function applyFilters() {
            const stateFilter = document.getElementById('state-filter').value;
            const typeFilter = document.getElementById('type-filter').value;
            const locationFilter = document.getElementById('location-filter').value;
            const searchFilter = document.getElementById('search-filter').value.toLowerCase();

            let visibleCount = 0;

            markers.forEach(marker => {
                const data = marker.institutionData;
                let show = true;

                // State filter
                if (stateFilter && data.state !== stateFilter) {
                    show = false;
                }

                // Type filter
                if (typeFilter && !data.programs.some(p => p.type === typeFilter)) {
                    show = false;
                }

                // Location filter
                if (locationFilter && !data.programs.some(p => p.location === locationFilter)) {
                    show = false;
                }

                // Search filter
                if (searchFilter && !data.institution.toLowerCase().includes(searchFilter)) {
                    show = false;
                }

                // Show/hide marker
                if (show) {
                    marker.addTo(map);
                    visibleCount++;
                } else {
                    map.removeLayer(marker);
                }
            });

            // Update visible count
            document.getElementById('visible-count').textContent = visibleCount;
        }

        function clearFilters() {
            document.getElementById('state-filter').value = '';
            document.getElementById('type-filter').value = '';
            document.getElementById('location-filter').value = '';
            document.getElementById('search-filter').value = '';

            // Show all markers
            markers.forEach(marker => marker.addTo(map));
            updateStats();
        }

        function updateStats() {
            document.getElementById('total-institutions').textContent = institutionData.size;
            document.getElementById('total-programs').textContent = allData.length;
            document.getElementById('visible-count').textContent = markers.length;
        }

        function addZoomListener() {
            map.on('zoomend', function() {
                createMarkers();
            });
        }

        // Update all note displays when page loads
        function updateAllNoteDisplays() {
            setTimeout(() => {
                Object.keys(userNotes).forEach(programId => {
                    const element = document.getElementById(`saved-notes-${programId}`);
                    if (element) {
                        updateNoteDisplay(programId);
                    }
                });
            }, 100);
        }

        // Initialize everything when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
            loadData();
            addZoomListener();
            updateAllNoteDisplays(); // Ê∑ªÂä†ËøôË°å

            // Add real-time search
            document.getElementById('search-filter').addEventListener('input', applyFilters);
        });
    </script>
</body>
</html> 